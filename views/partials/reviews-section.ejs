<div class="reviews-section">
    <div class="reviews-header">
        <h2>Customer Reviews</h2>

        <% if (avgRating && avgRating.review_count> 0) { %>
            <div class="average-rating">
                <div class="stars-display">
                    <% for(let i=1; i <=5; i++) { %>
                        <span class="star <%= i <= Math.round(avgRating.avg_rating) ? 'filled' : '' %>">★</span>
                        <% } %>
                </div>
                <span class="rating-text">
                    <%= avgRating.avg_rating %> out of 5 (<%= avgRating.review_count %>
                            <%= avgRating.review_count===1 ? 'review' : 'reviews' %>)
                </span>
            </div>
            <% } else { %>
                <p class="no-reviews-yet">There are no reviews for this vehicle yet.</p>
                <% } %>
    </div>

    <!-- Button to add a review (authenticated users only) -->
    <% if (accountData) { %>
        <div class="add-review-btn-container">
            <a href="/review/add/<%= invData.inv_id %>" class="btn-add-review">
                ✍️ Write a review
            </a>
        </div>
        <% } else { %>
            <p class="login-prompt">
                <a id="loginreview" href="/account/login">Log in</a> to write a review
            </p>
            <% } %>

                <!-- Reviews list -->
                <% if (reviews && reviews.length> 0) { %>
                    <div class="reviews-list">
                        <% reviews.forEach(review=> { %>
                            <div class="review-card">
                                <div class="review-header">
                                    <div class="reviewer-info">
                                        <div class="reviewer-avatar">
                                            <%= review.initials %>
                                        </div>
                                        <div class="reviewer-details">
                                            <span class="reviewer-name">
                                                <%= review.account_firstname %>
                                                    <%= review.account_lastname %>
                                            - </span>
                                            <span class="review-date">
                                                <%= new Date(review.review_date).toLocaleDateString('en-US',
                                                    {year: 'numeric' , month: 'long' , day: 'numeric' }) %>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="review-rating">
                                        <% for (let i=1; i <=5; i++) { %>
                                            <span class="star <%= i <= Number(review.review_rating) ? 'filled' : '' %>">
                                                ★
                                            </span>
                                            <% } %>
                                    </div>

                                </div>

                                <div class="review-text">
                                    <p>
                                        <%= review.review_text %>
                                    </p>
                                </div>

                                <!-- Edit/delete buttons if the author -->
                                <% if (accountData && parseInt(accountData.account_id)===parseInt(review.account_id)) {
                                    %>
                                    <div class="review-actions">
                                        <a href="/review/edit/<%= review.review_id %>" class="btn-edit">Edit</a>
                                        <a href="/review/delete/<%= review.review_id %>" class="btn-delete"
                                            onclick="return confirm('Are you sure you want to delete this review?')">
                                            Delete
                                        </a>
                                    </div>
                                    <% } %>
                            </div>
                            <% }) %>
                    </div>
                    <% } %>
</div>